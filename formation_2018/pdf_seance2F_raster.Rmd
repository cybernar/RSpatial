---
title: "Le package raster"
author: "Cyril Bernard (CEFE-CNRS)"
date: "31 janvier 2019"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# TP6. Masques. Statistiques zonales. Statistiques focales.

## 6.1. Utilisation des masques
Un **masque** est une zone d'intérêt en dehors de laquelle les pixels sont ignorés. 

Le masque peut être défini de 2 manières :

- à partir d'un objet SpatialPolygons (issu d'1 shapefile)
- à partir d'un raster dont les pixels à ignorer portent le valeur NA

La fonction `mask` permet d'appliquer un masque à d'autre raster.

---

### 6.1.1. Exercice 

**Exercice** : créer un masque à partir de CLC 2012 niveau 2. Assigner les valeurs NA aux pixels = 42 ou 52.
Appliquer ce masque sur le raster NDVI.

```{r Exercice 611: masques}
# chargement des donnees
library(raster)
rast_ndvi <- raster("data/NDVI_S2A_20180504_T31UCR.tif")
rast_clc80_niv2 <- raster("data/CLC/CLC12_D080_NIV2.tif")
# masque
rast_mask <- rast_clc80_niv2
rast_bool <- rast_clc80_niv2 %in% c(42,52)
rast_mask[rast_bool] <- NA
rast_ndvi_mask <- mask(rast_ndvi, rast_mask)
library(RColorBrewer)
pal_YlGr <- brewer.pal(5,"YlGn")
lim <- c(-1, 0, 0.2, 0.5, 0.8, 1)
plot(rast_ndvi_mask,col=pal_YlGr,breaks=lim)
```


## 6.1.2. Exercice masque

**Exercice** : afficher la distribution du NDVI pour les zones de cultures

```{r mask et distribution des valeurs avec ggplot2, eval=FALSE}
library(ggplot2)
ggplot(data=data.frame(NDVI=rast_ndvi_mask[])) +
  geom_histogram(mapping=aes(x=NDVI), binwidth=0.01)
```

## 6.2. Stats zonales

La fonction `zonal` agrége les données issues d'un raster x, d'après les zones 
définies dans un raster z.

**Exemple** : ```x``` contient des valeurs de ndvi (variables quantitatives), 
et ```z``` contient des codes d'occupation du sol. Pour chaque type d'occupation du sol,
on voudrait connaître le NDVI moyen (```mean```) et la dispersion (```sd```).

```{r calcul NDVI moyen par code CLC}
ndvi_by_clc_mean <- zonal(x=rast_ndvi, z=rast_clc80_niv2, fun="mean")
```

## 6.2.1. Exercice `zonal`

**Exercice** : pour chaque type d'occupation du sol, calculer la dispersion de la
valeur de NDVI (utiliser zonal avec la fonction sd```sd```) et la surface totale 
du type d'occupation du sol en ha (utiliser freq).

```{r calcul NDVI moyen par code CLC}
ndvi_by_clc_sd <- zonal(x=rast_ndvi, z=rast_clc80_niv2, fun="sd")
surf_by_clc <- freq(rast_clc80_niv2)
df_stats_by_clc <- data.frame(CODE=ndvi_by_clc_mean[,1], 
                              NDVI_MEAN=ndvi_by_clc_mean[,2], 
                              NDVI_SD=ndvi_by_clc_sd[,2], 
                              SURF_HA=surf_by_clc[,2] * 0.01)

```

## 6.3. Extraction de valeurs et stats zonales avec `extract`

La fonction `extract` prend en entrée un raster `x` et une source de données vectorielles `y` (points, lignes ou polygones).

---

### 6.3.1. Extraction de valeurs avec des points

Si `y` est un ensemble de points, `extract` renvoie la valeur du raster `x` à la position des points. On peut aussi indiquer un rayon de recherche avec `buffer=` et une fonction avec `fun=` pour chercher et agréger les données (exemple : moyenne du NDVI dans un rayon de n mètres autour des points)

```{r extract points}
pp <- c("sol nu 1", "sol nu 2", "conifere 1", "conifere 2", "maraich 1")
px <- c(400560, 401740, 397320, 398330, 401460)
py <- c(5572420, 5570420, 5570260, 5571820, 5567670)
# extraire le NDVI à la position des points
ndvi_pts <- extract(x=rast_ndvi, y=cbind(px, py))
# extraire le NDVI moyen dans un rayon de 100 m autour des points
ndvi_pts_100 <- extract(x=rast_ndvi, y=cbind(px, py), buffer=100, fun=mean, na.rm=T)
```

---

### 6.3.2. Extraction de valeurs avec des polygones

Si `y` est un ensemble de polygones, on peut agréger les valeurs des pixels pour chaque polygones en indiquant une function après `fun=`

```{r extract polygones}
# extraire le NDVI moyen par code CLC, à partir du fichier vectoriel CLC
library(rgdal)
shp_clc_utm <- readOGR(dsn="data/CLC", layer="CLC12_D080_UTM31N")
ndvi_by_polygone <- extract(x=rast_ndvi, y=shp_clc_utm, fun=mean, na.rm=F)
shp_clc_utm$ndvi_mean <- as.numeric(ndvi_by_polygone)
polygones_with_ndvi <- as.logical(!is.na(ndvi_by_polygone))
shp_clc_utm2 <- shp_clc_utm[polygones_with_ndvi,]
plot(rast_ndvi,col=pal_YlGr,breaks=lim)
plot(shp_clc_utm2, add=T, col=pal_YlGr[findInterval(shp_clc_utm2$ndvi_mean, lim)])
```

### 6.3.3. Exercice: que fait la fonction suivante ?

```{r exercice 633}
test <- extract(x=rast_clc80_niv2, y=cbind(px, py), buffer=1000, 
                fun=function(x) length(unique(x)))
```

## 6.4. Statistiques focales

La fonction `focal` calcule pour chaque pixel du raster en entrée une valeur d'après son voisinage. Le principe est de définir une fenêtre de calcul sous la forme d'une **matrice de poids** puis d'y appliquer une fonction (ex : sum, mean, modal).

### 6.4.1. Exemples de matrice pour la fenêtre de calcul

```{r focal matrix}
# une fenetre rectangulaire
mr1 <- matrix(1, nrow=3, ncol=3)
# une fenetre rectangulaire avec une somme = 1
mr2 <- matrix(1/9, nrow=3, ncol=3)
# une fenetre circulaire de 50 m de rayon (soit 11x11)
mc1 <- focalWeight(rast_ndvi, d=50, type='circle')
```

Remarque : la fenêtre a toujours des dimensions impaires (3x3, 5x5...) 

--- 

### 6.4.2. Exemples d'applications

- Lissage de données raster : moyenne des valeurs ds un rayon de n mètres, gaussienne avec un rayon de recherche
- Dilatation / érosion : dilater les zones avec des pixels forêts
- Automates cellulaires : en fonction des voisins, faire vivre ou mourir un pixel ...

### 6.4.2. Exemple : calcul de moyenne avec différentes fenêtres de calcul

### 6.4.3. Exercice : dilatation

### 6.4.4. Exercice : mode, nombre de valeurs uniques



https://www.somme-tourisme.com/les-crocs-autour-du-marquenterre/saint-quentin-en-tourmont/randopic0800000j
https://picardie.media.tourinsoft.eu/upload/Lescrocs.gpx

https://www.data.gouv.fr/fr/datasets/decoupage-administratif-communal-francais-issu-d-openstreetmap/
http://osm13.openstreetmap.fr/~cquest/openfla/export/communes-20190101-shp.zip

