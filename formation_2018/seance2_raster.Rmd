---
title: "La package raster"
author: "Cyril Bernard (CEFE-CNRS)"
date: "29 janvier 2018"
output: ioslides_presentation
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Présentation du package raster

## Le package raster

Grâce au package **raster**, il est possible dans R de traiter des données au format raster (grille de données spatiales). Le package offre une palette d'outils assez comparable à celle aux logiciels SIG raster tels que GRASS, IDRISI, ESRI Spatial Analyst, SAGA, etc.

- Calculatrice raster
- Résumés statistiques (distribution, min et max, stats zonales)
- Utilisation de masque
- Fonctions de voisinage (focal)

## Modèle de données

Le package **raster** gère les raster à 1 couche (_raster_) ou à plusieurs couches (_brick_ ou _stack_).

R et le package raster offre plus de souplesse et de possibilités qu'un SIG Bureautique lorsque le nombre de couches de données superposées est important.

## Packages complémentaires : lecture / écriture de fichiers raster

Le package **raster** gère par défaut les formats GeoTiff (.tif), ESRI Ascii (.asc), ENVI (.nvi), IDRISI (.rst), ESRI BIL (.bil). 
D'autres formats sont disponibles via le package rgdal.


## §§§ Packages complémentaires : gdalUtils

Les fonctions du package **raster** sont généralement efficaces en terme de calcul. Mais les fonctions rasterize (rasterisation de données vectorielles) et projectRaster (reprojection dans un autre système de coordonnées) laisse à désirer. 

Il est préférable dans ces 2 cas d'utiliser les fonctions gdal_rasterize et gdalwarp du package gdalUtils qui sont très rapides.

## §§§ Packages complémentaires : outils métiers

Les fonctionnalités proposées par **raster** sont étoffées ; cependant le package ne propose pas d'outils "métiers" pour des discipline très spécifique comme l'hydrologie (calcul de bassin versant), l'aménagement (chemin de moindre coût), l'énergie (rayonnement solaire). Ces outils se trouvent généralement dans des packages tierces.

Exemple : le package **gdistance** pour les distances et chemins de moindre coût.

# Le package raster : COURS

## La classe raster

La classe raster 

## Un raster "from scratch"

```{r Créer un raster vide}
library(raster)
r_crs <- CRS("+proj=longlat +datum=WGS84 +no_defs")
r_ext <- extent(c(-180,180,-90,90)) # les bords 
r_val <- 0 # valeur : des 0 partout
r_res <- 1 # resolution : 1 degré
rast_vide <- raster(crs=r_crs, ext=r_ext, resolution=r_res, vals=r_val)
rast_vide
```

## Lire l'étendue, la résolution, le système de coordonnées d'un raster
```{r Informations sur le raster}
crs(rast_vide)
extent(rast_vide)
xmin(rast_vide)
nrow(rast_vide)
ncol(rast_vide)
res(rast_vide)
```

## Lire et modifier les valeurs d'un raster
```{r Lire et modifier les valeurs}
v <- rast_vide[]
rast_vide[] <- runif(360*180, 0, 100)
rast_vide[1] # valeur du pixel 1
xyFromCell(rast_vide,1) # coordonnees geographiques du pixel 1
rowColFromCell(rast_vide,361)
```

## Visualiser un raster avec plot
```{r Visualisation}
plot(rast_vide)
```

## Lire un raster
```{r Lecture fichier GeoTIFF}
rast_prec01 <- raster("data/WorldClim/wc2.0_10m_prec_01.tif")
rast_prec01
```


## Exercice 1
Déterminer les précipitations du mois de janvier pour Montpellier (3.8°E,43.6°N) et Paris (2.3°E, 48.8°N)
```{r Exercice : extraction de valeur avec des points}
# on commence par créer une matrice avec x et y en colonnes
villes_coords <- matrix(c(3.8, 2.3, 43.6, 48.8), ncol=2, dimnames=list(c("MTP","PAR"), c("long","lat")))
villes_coords
# methode 1 : determiner l'index des pixels avec cellFromXY, puis chercher la valeur
villes_ncell <- cellFromXY(rast_prec01,villes_coords)
rast_prec01[villes_ncell]
# methode 2 : avec extract
extract(rast_prec01, villes_coords)
```

## La gestion des 'NA' (absence de données) dans les fichiers raster
Notre raster "précipitation janvier" contient les pixels "sans données"
```{r Les pixels peuvent comporter des valeurs 'NA'}
head(rast_prec01[])
```
Dans un fichier raster, chaque pixel a une valeur numérique. 
```{r}
library(gdalUtils)
gdalinfo("data/WorldClim/wc2.0_10m_prec_01.tif")
```

## Enregistrer un raster
```{r }
writeRaster(rast_vide, "data/rast_vide.tif")
writeRaster(rast_int, "data/rast_vide.asc", format="ascii")
writeRaster(rast_int, "data/rast_vide.asc", format="ascii", overwrite=T, NAflag=-99)
rast_int <- trunc(rast_vide)
rast_int[2] <- NA
writeRaster(rast_int, "data/rast_integer.tif", datatype='INT2S')
```

## Caractéristique de la classe Raster
```{r}
getClass("Raster")
```

## La classe brick
Une "brick" est un raster multi-couches issu d'1 fichier multi-couches.
```{r}
rast_l8 <- brick("data/Landsat8/l8_20171121_extr.tif")
rast_l8
nlayers(rast_l8)
plot(rast_l8)
```

Pour obtenir une composition colorée RGB, utiliser la fonction plotRGB
```{r}
plotRGB(rast_l8, stretch="lin")
```


## La classe stack
Une "stack" (pile) est un raster multi-couches issu de plusieurs fichiers (ou plusieurs objets raster).
C'est donc un assemblage de plusieurs rasters à superposer. Il est possible de spécifier une liste de fichiers raster.
Pour travailler proprement, utiliser en entrée des rasters de même étendue et de même résolution.
Exemple : création d'un objet "stack" avec les précipitations sur 12 mois.

```{r}
# liste des fichiers wc2*.tif dans le répertoire WorldClim
list_fich <- list.files(path="data/WorldClim", pattern="wc2.*\\.tif", full.names=T)
rast_precip <- stack(list_fich, quick=T)
names(rast_precip)
names(rast_precip) <- c("PREC.JAN", "PREC.FEB", "PREC.MAR", "PREC.APR", "PREC.MAY", "PREC.JUN",
                        "PREC.JUL", "PREC.AUG", "PREC.SEP", "PREC.OCT", "PREC.NOV", "PREC.DEC")
plot(rast_precip)
```

## Exercice 2
Extraire les valeurs précipitation sur 12 mois pour Montpellier et Paris avec extract.
Puis générer un nouveau raster avec la somme des précipitations annuelles (utiliser la fonction calc)
```{r}
villes_precip <- extract(rast_precip, villes_coords)
rast_sum_precip <- calc(rast_precip, fun=sum)
plot(rast_sum_precip)
```

## Outils de résumés statistiques
cellStats
freq
zonal
extract

## 

## quand utiliser gdalUtils ?


La package propose des fonctionnalités de base (lecture, écriture, calculatrice raster) et plus plus évolué


Les possibilités  Les outils disponibles dans le package et de faire 

